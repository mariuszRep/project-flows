# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a TypeScript implementation of the MCP (Model Context Protocol) server, equivalent to the Python version in `/root/projects/mcp-python/`. The project contains a single MCP server that provides task creation and planning functionality through a "create_task" tool.

## Architecture

- **Main Server**: `src/index.ts` - The primary MCP server implementation in TypeScript
- **Storage Layer**: `src/storage.ts` - In-memory task and block storage with CRUD operations
- **Schema Configuration**: `schema_properties.json` - Defines dynamic schema properties for task creation
- **Build Output**: `dist/` - Compiled JavaScript output (generated by TypeScript compiler)

### Core Components

- The server implements MCP protocol using the `@modelcontextprotocol/sdk` TypeScript library
- Tool registration system with dynamic schema loading from JSON configuration
- Dependency validation and execution ordering for task properties
- Markdown output formatting for task plans
- **New**: Separated data layer with Task and Block entities for better data modeling

### Data Model

The storage layer implements a proper separation between task-level metadata and block-level content:

- **Task Entity**: `id`, `title`, `created_by`, `created_at`, `version` - Core task metadata
- **Block Entity**: `id`, `task_id`, `block_type`, `content`, `created_at`, `updated_at` - Content blocks
- **In-memory Storage**: Uses `Map<number, Task>` for tasks and `Map<number, Block[]>` for blocks
- **CRUD Operations**: Helper functions for creating, reading, updating, and deleting tasks and blocks
- **Schema Validation**: Block types are validated against `schema_properties.json`

## Development Commands

### Environment Setup
```bash
# Install dependencies
npm install

# Build the project
npm run build

# Run the server (connects via stdio)
npm start

# Development mode with auto-reload
npm run dev

# Clean build artifacts
npm run clean

# Run unit tests
npm test
```

### Dependencies
- Node.js (ES2022 compatible)
- TypeScript 5.x
- @modelcontextprotocol/sdk - MCP SDK for TypeScript
- tsx - TypeScript execution for development

## Key Implementation Details

- The server provides three tools:
  - `create_task`: Creates a new task plan (requires Title and Summary, accepts dynamic properties)
  - `update_task`: Updates an existing task plan (all fields optional, validates dependencies)
  - `get_item`: Retrieves a complete task by numeric ID
- Dynamic properties are loaded from `schema_properties.json` with execution order and dependency management
- Properties include Research (depends on Summary) and Items (depends on Summary and Research)
- Output is formatted as structured markdown with sections for each property
- Server runs over stdio communication channel
- Equivalent functionality to the Python version with identical schema and behavior

## Tool Usage Examples

### create_task
Creates a complete task plan with automatic numeric task ID generation:

```json
{
  "name": "create_task",
  "arguments": {
    "Title": "Implement user authentication system",
    "Summary": "Add secure login/logout functionality with session management",
    "Research": "Technical requirements: OAuth 2.0, JWT tokens, password hashing with bcrypt, session storage in Redis. Business constraints: Must integrate with existing user database. Dependencies: Redis server, OAuth provider setup.",
    "Items": "- Set up OAuth 2.0 configuration\n- Implement JWT token generation and validation\n- Create password hashing utilities\n- Build login/logout endpoints\n- Add session middleware\n- Write comprehensive tests"
  }
}
```

**Output includes Task ID:**
```markdown
# Task
**Task ID:** 1

**Title:** Implement user authentication system

## Summary
Add secure login/logout functionality with session management
...
```

### update_task
Updates specific fields of an existing task by numeric task ID. The `task_id` field is required, all other fields are optional. **No dependency validation is enforced for updates** - you can update any field independently.

#### Single field updates:
```json
{
  "name": "update_task", 
  "arguments": {
    "task_id": 1,
    "Title": "Enhanced user authentication system"
  }
}
```

#### Update any field independently:
```json
{
  "name": "update_task",
  "arguments": {
    "task_id": 1,
    "Research": "Updated research findings"
  }
}
```

#### Multi-field updates:
```json
{
  "name": "update_task",
  "arguments": {
    "task_id": 1,
    "Summary": "Updated summary with new requirements",
    "Research": "Updated research findings with additional security considerations"
  }
}
```

#### Task ID validation:
- ✅ Valid: `{"task_id": 1, "Title": "..."}` (numeric ID ≥ 1)
- ❌ Invalid: `{"Title": "..."}` (missing task_id)
- ❌ Invalid: `{"task_id": "1", "Title": "..."}` (string ID)
- ❌ Invalid: `{"task_id": 0, "Title": "..."}` (ID must be ≥ 1)

#### Dependency behavior:
- ✅ `{"task_id": 1, "Research": "..."}` (can update Research alone)
- ✅ `{"task_id": 1, "Items": "..."}` (can update Items alone)
- ✅ `{"task_id": 1, "Summary": "...", "Research": "..."}` (can update multiple fields)
- **Note:** Dependencies are only validated during initial task creation with `create_task`, not during updates

### get_item
Retrieves a complete task by its numeric ID. Returns all stored task data in the same format as create_task.

#### Basic retrieval:
```json
{
  "name": "get_item",
  "arguments": {
    "task_id": 1
  }
}
```

#### Task ID validation:
- ✅ Valid: `{"task_id": 1}` (numeric ID ≥ 1)
- ❌ Invalid: `{}` (missing task_id)
- ❌ Invalid: `{"task_id": "1"}` (string ID)
- ❌ Invalid: `{"task_id": 0}` (ID must be ≥ 1)

#### Output format:
```markdown
# Task
**Task ID:** 1

**Title:** [Task Title]

## Summary
[Task Summary]

## Research
[Research Content]

## Items
[Items Content]
```

#### Error handling:
- **Missing task**: Returns `Error: Task with ID [id] not found.`
- **Invalid ID**: Returns `Error: Valid numeric task_id is required for retrieval.`

## Testing

The project includes comprehensive unit tests for the storage layer:

- **Test Framework**: Node.js built-in test runner with `tsx`
- **Test Coverage**: Task CRUD operations, Block CRUD operations, edge cases
- **Test File**: `src/storage.test.ts` - Tests for all storage functions
- **Test Execution**: `npm test` - Runs all tests with TAP output

### Test Structure

- **Task Storage Tests**: createTask, updateTask, getTask functionality
- **Block Storage Tests**: addBlock, updateBlock, getBlocks, getBlockByType functionality
- **Output Aggregation Tests**: aggregateFinalOutput functionality with comprehensive edge case coverage
- **Edge Cases**: duplicate handling, data validation, error conditions, null/undefined inputs, large payloads
- **Data Isolation**: Each test uses `resetStorage()` for clean state

### Output Aggregation

The storage layer includes a unified output aggregator function that consolidates the results of multiple tool calls:

#### `aggregateFinalOutput(taskOutput, blocksOutput, metadataOutput): AggregatedOutput`

**Purpose**: Combines task data, blocks, and metadata into a single standardized result object for easy consumption by callers.

**Parameters**:
- `taskOutput`: Task | null - Task object or null if not available
- `blocksOutput`: Block[] - Array of blocks (gracefully handles invalid input)
- `metadataOutput`: Record<string, any> | null - Additional metadata to include

**Returns**: AggregatedOutput interface with:
```typescript
interface AggregatedOutput {
  task: Task | null;
  blocks: Block[];
  metadata: {
    taskId: number;
    totalBlocks: number;
    hasContent: boolean;
    aggregatedAt: Date;
    // ...additional metadata from metadataOutput
  };
}
```

**Features**:
- **Null-safe**: Handles null/undefined inputs gracefully
- **Type-safe**: Strong TypeScript typing with interface validation
- **Defensive**: Validates array inputs and provides safe defaults
- **Extensible**: Merges additional metadata while preserving core fields
- **Large payload support**: Efficiently handles substantial data volumes

**Usage Example**:
```typescript
const task = getTask(1);
const blocks = getBlocks(1);
const metadata = { version: 1, source: 'api' };

const result = aggregateFinalOutput(task, blocks, metadata);
// Returns complete aggregated result with task, blocks, and enriched metadata
```

## Future Migration to PostgreSQL

The current in-memory storage layer is designed for easy migration to PostgreSQL:

### Database Schema

```sql
-- Tasks table
CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    created_by VARCHAR(100) NOT NULL DEFAULT 'system',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    version INTEGER DEFAULT 1
);

-- Blocks table  
CREATE TABLE blocks (
    id SERIAL PRIMARY KEY,
    task_id INTEGER REFERENCES tasks(id) ON DELETE CASCADE,
    block_type VARCHAR(50) NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Migration Strategy

1. **Replace Storage Maps**: Replace `Map<number, Task>` with database queries
2. **Update CRUD Functions**: Modify storage functions to use SQL queries instead of map operations
3. **Add Connection Pool**: Implement proper database connection management
4. **Preserve API Surface**: Keep the same function signatures for seamless migration
5. **Data Validation**: Schema validation remains the same using `schema_properties.json`

### Benefits of Current Design

- **API Stability**: Function signatures won't change during migration
- **Type Safety**: TypeScript interfaces define exact database schema
- **Test Coverage**: Existing tests validate business logic independent of storage
- **Clean Separation**: MCP server logic is decoupled from storage implementation

## Build Process

The project uses TypeScript compilation:
- Source files in `src/` are compiled to `dist/`
- ES modules with Node.js compatibility
- Source maps and declarations generated for debugging
- Strict TypeScript configuration for type safety