# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a TypeScript implementation of the MCP (Model Context Protocol) server with SSE (Server-Sent Events) support for multiple concurrent clients. The project provides task creation and planning functionality through multiple tools with shared database persistence.

## Architecture

- **Main Server**: `src/index.ts` - The primary MCP server implementation in TypeScript
- **Schema Configuration**: `schema_properties.json` - Defines dynamic schema properties for task creation
- **Build Output**: `dist/` - Compiled JavaScript output (generated by TypeScript compiler)

### Core Components

- **SSE Multi-Client Support**: Express.js server with SSE transport for concurrent client connections
- **Shared Database**: PostgreSQL database service shared across all client sessions
- **Session Management**: Individual MCP server instances per client with session tracking
- Tool registration system with dynamic schema loading from database/JSON configuration
- Dependency validation and execution ordering for task properties
- Markdown output formatting for task plans

## Development Commands

### Environment Setup
```bash
# Install dependencies
npm install

# Build the project
npm run build

# Run the SSE server (HTTP server on port 3001)
npm start

# Development mode with auto-reload
npm run dev

# Clean build artifacts
npm run clean
```

### Dependencies
- Node.js (ES2022 compatible)
- TypeScript 5.x
- @modelcontextprotocol/sdk - MCP SDK for TypeScript
- Express.js 5.x - Web server for SSE endpoints
- CORS - Cross-origin resource sharing support
- PostgreSQL (pg) - Database client
- Zod - Schema validation
- tsx - TypeScript execution for development

## Key Implementation Details

- The server provides three tools:
  - `create_task`: Creates a new task plan (requires Title and Summary, accepts dynamic properties)
  - `update_task`: Updates an existing task plan (all fields optional, validates dependencies)
  - `get_item`: Retrieves a complete task by numeric ID
- Dynamic properties are loaded from `schema_properties.json` with execution order and dependency management
- Properties include Research (depends on Summary) and Items (depends on Summary and Research)
- Output is formatted as structured markdown with sections for each property
- Server runs over HTTP with SSE (Server-Sent Events) for real-time communication
- Multiple clients can connect simultaneously, sharing the same database
- Each client gets its own MCP server instance with session management
- Default port: 3001 (configurable via PORT environment variable)

## Tool Usage Examples

### create_task
Creates a complete task plan with automatic numeric task ID generation:

```json
{
  "name": "create_task",
  "arguments": {
    "Title": "Implement user authentication system",
    "Summary": "Add secure login/logout functionality with session management",
    "Research": "Technical requirements: OAuth 2.0, JWT tokens, password hashing with bcrypt, session storage in Redis. Business constraints: Must integrate with existing user database. Dependencies: Redis server, OAuth provider setup.",
    "Items": "- Set up OAuth 2.0 configuration\n- Implement JWT token generation and validation\n- Create password hashing utilities\n- Build login/logout endpoints\n- Add session middleware\n- Write comprehensive tests"
  }
}
```

**Output includes Task ID:**
```markdown
# Task
**Task ID:** 1

**Title:** Implement user authentication system

## Summary
Add secure login/logout functionality with session management
...
```

### update_task
Updates specific fields of an existing task by numeric task ID. The `task_id` field is required, all other fields are optional. **No dependency validation is enforced for updates** - you can update any field independently.

#### Single field updates:
```json
{
  "name": "update_task", 
  "arguments": {
    "task_id": 1,
    "Title": "Enhanced user authentication system"
  }
}
```

#### Update any field independently:
```json
{
  "name": "update_task",
  "arguments": {
    "task_id": 1,
    "Research": "Updated research findings"
  }
}
```

#### Multi-field updates:
```json
{
  "name": "update_task",
  "arguments": {
    "task_id": 1,
    "Summary": "Updated summary with new requirements",
    "Research": "Updated research findings with additional security considerations"
  }
}
```

#### Task ID validation:
- ✅ Valid: `{"task_id": 1, "Title": "..."}` (numeric ID ≥ 1)
- ❌ Invalid: `{"Title": "..."}` (missing task_id)
- ❌ Invalid: `{"task_id": "1", "Title": "..."}` (string ID)
- ❌ Invalid: `{"task_id": 0, "Title": "..."}` (ID must be ≥ 1)

#### Dependency behavior:
- ✅ `{"task_id": 1, "Research": "..."}` (can update Research alone)
- ✅ `{"task_id": 1, "Items": "..."}` (can update Items alone)
- ✅ `{"task_id": 1, "Summary": "...", "Research": "..."}` (can update multiple fields)
- **Note:** Dependencies are only validated during initial task creation with `create_task`, not during updates

### get_item
Retrieves a complete task by its numeric ID. Returns all stored task data in the same format as create_task.

#### Basic retrieval:
```json
{
  "name": "get_item",
  "arguments": {
    "task_id": 1
  }
}
```

#### Task ID validation:
- ✅ Valid: `{"task_id": 1}` (numeric ID ≥ 1)
- ❌ Invalid: `{}` (missing task_id)
- ❌ Invalid: `{"task_id": "1"}` (string ID)
- ❌ Invalid: `{"task_id": 0}` (ID must be ≥ 1)

#### Output format:
```markdown
# Task
**Task ID:** 1

**Title:** [Task Title]

## Summary
[Task Summary]

## Research
[Research Content]

## Items
[Items Content]
```

#### Error handling:
- **Missing task**: Returns `Error: Task with ID [id] not found.`
- **Invalid ID**: Returns `Error: Valid numeric task_id is required for retrieval.`

## Build Process

The project uses TypeScript compilation:
- Source files in `src/` are compiled to `dist/`
- ES modules with Node.js compatibility
- Source maps and declarations generated for debugging
- Strict TypeScript configuration for type safety